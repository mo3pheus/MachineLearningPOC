package maze.environment;

import java.util.Properties;
import java.util.List;
import java.util.ArrayList;

import maze.environment.Wall.IllegalWallDefinitionException;

import java.awt.*;
import java.awt.geom.Line2D;
import java.io.FileInputStream;

public class Maze extends Frame {
	/**
	 * 
	 */
	private static final long	serialVersionUID		= 34L;

	private static final String	FRAME_HEIGHT_PROPERTY	= "maze.environment.frame.height";
	private static final String	FRAME_WIDTH_PROPERTY	= "maze.environment.frame.width";
	private static final String	CELL_WIDTH_PROPERTY		= "maze.environment.cell.width";
	private static final String	NUM_WALLS_PROPERTY		= "maze.environment.num.walls";
	private static final String	WALL_DEFS_PROPERTY		= "maze.environment.wall.definitions";
	private static final String	START_POSN_PROPERTY		= "maze.environment.start.position";
	private static final String	DESTN_POSN_PROPERTY		= "maze.environment.destination.position";

	private List<Pair>			gridPoints;
	private String				wallDef;
	private int					frameHeight;
	private int					frameWidth;
	private int					cellWidth;
	private int					numWalls;
	private Point				startPosn;
	private Point				destPosn;

	private Wall[]				walls;
	private Line2D[]			grid;
	private Graphics2D			g2;
	private MazeListener		mazeListener			= new MazeListener();

	/**
	 * @param properties
	 * 
	 *            The following properties are essential.
	 *            "maze.environment.frame.height",
	 *            "maze.environment.frame.width", "maze.environment.cell.width",
	 *            "maze.environment.num.walls",
	 *            "maze.environment.wall.definitions";
	 */
	public Maze(Properties properties) {
		/*
		 * Call parent
		 */
		super("ROBO-MAZE");

		/*
		 * Collect properties for maze definition
		 */
		this.frameHeight = Integer.parseInt(properties.getProperty(FRAME_HEIGHT_PROPERTY));
		this.frameWidth = Integer.parseInt(properties.getProperty(FRAME_WIDTH_PROPERTY));
		this.cellWidth = Integer.parseInt(properties.getProperty(CELL_WIDTH_PROPERTY));

		/*
		 * Define walls, gridPoints, travelCells
		 */
		defineEndPoints(properties.getProperty(START_POSN_PROPERTY), properties.getProperty(DESTN_POSN_PROPERTY));
		defineGrid();
		try {
			defineWalls(properties);
		} catch (IllegalWallDefinitionException e) {
			e.printStackTrace();
		}

		/*
		 * Instantiate essentials
		 */
		this.setSize(frameWidth, frameHeight);
		this.gridPoints = new ArrayList<Pair>();
		this.setVisible(true);
		this.setName("RoboMaze");
		this.addWindowListener(mazeListener);
	}

	private void defineWalls(Properties properties) throws IllegalWallDefinitionException {
		this.numWalls = Integer.parseInt(properties.getProperty(NUM_WALLS_PROPERTY));
		this.walls = new Wall[this.numWalls];

		for (int i = 0; i < numWalls; i++) {
			String wallDef = properties.getProperty(WALL_DEFS_PROPERTY + "." + Integer.toString(i));
			String[] walParamStr = wallDef.split(",");
			int[] walParams = new int[4];
			if (walParamStr.length != 4) {
				System.out.println(" Wall params and wall Prop string are incompatible.");
				return;
			}

			for (int j = 0; j < walParams.length; j++) {
				walParams[j] = Integer.parseInt(walParamStr[j]);
			}

			walls[i] = new Wall(this, walParams);
		}
	}

	private void defineEndPoints(String startDef, String endDef) {
		this.startPosn = new Point(Integer.parseInt(startDef.split(",")[0]), Integer.parseInt(startDef.split(",")[1]));
		this.destPosn = new Point(Integer.parseInt(endDef.split(",")[0]), Integer.parseInt(endDef.split(",")[1]));
	}

	private void defineGrid() {
		for (int x = 0; x < this.getWidth(); x = x + cellWidth) {
			Pair temp = new Pair(new Point(x, 0), new Point(x, this.getHeight()));
			gridPoints.add(temp);
		}

		for (int y = 0; y < this.getHeight(); y = y + cellWidth) {
			Pair temp = new Pair(new Point(0, y), new Point(this.getWidth(), y));
			gridPoints.add(temp);
		}
	}

	public void renderMaze(Graphics2D g2) {
		/*
		 * 1) Draw the frame 2) draw the grid lines 3) draw the walls 4) set
		 * originCar 5) set destinationCell
		 */
		if(gridPoints.isEmpty()) {
			System.out.println("Sorry grid is empty");
		}
		
		for (int i = 0; i < gridPoints.size(); i++) {
			Pair linePoints = gridPoints.get(i);
			System.out.println(linePoints.toString());
			g2.drawLine((int) linePoints.getA().getX(), (int) linePoints.getA().getY(), (int) linePoints.getB().getX(),
					(int) linePoints.getB().getY());
		}

	}

	public void paint(Graphics g) {
		super.paint(g);
		System.out.println("Rendering the graphics now");
		renderMaze((Graphics2D) g);
	}

	public static void main(String[] args) throws Exception {
		System.out.println("Hello from the RoboMaze");
		// FileInputStream propFile = new FileInputStream(args[0]);
		FileInputStream propFile = new FileInputStream(
				"//home/sanket//Documents//Code//MyProjects//Java/MavenProjects//codingGym//SwingSet//src//main//resources//mazeDefinition.properties");
		Properties mazeProperties = new Properties();
		mazeProperties.load(propFile);

		new Maze(mazeProperties);
		// maze.renderMaze(g2);
	}

}
